# Base Docker Compose Configuration
# This file contains the base configuration for all services
# Use docker-compose.override.yml for local development
# Use docker-compose.prod.yml for production

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:latest
    container_name: secure-drop-traefik
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=secure-drop-network"
      - "--entrypoints.web.address=:80"
      - "--log.level=DEBUG"
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - secure-drop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Laravel Backend API
  backend:
    build:
      context: ./backend
      target: production
    container_name: secure-drop-backend
    working_dir: /var/www/html
    volumes:
      - backend-data:/var/www/html/storage
      - backend-db:/var/www/html/database
    networks:
      - secure-drop-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`secure-drop.localhost`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
      - "traefik.http.services.backend.loadbalancer.healthcheck.path=/up"
      - "traefik.http.services.backend.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.backend.loadbalancer.healthcheck.timeout=5s"
    restart: unless-stopped
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # React Frontend
  frontend:
    build:
      context: ./frontend
      target: production
    container_name: secure-drop-frontend
    networks:
      - secure-drop-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`secure-drop-ui.localhost`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.timeout=5s"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  secure-drop-network:
    driver: bridge

volumes:
  backend-data:
  backend-db:
