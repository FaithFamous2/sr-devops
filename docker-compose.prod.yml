# Docker Compose Production Configuration
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # Traefik - Production configuration with SSL
  traefik:
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - letsencrypt:/letsencrypt
    restart: always

  # =============================================================================
  # DATABASE CONFIGURATION (PRODUCTION)
  # =============================================================================
  # For production, MySQL is recommended over SQLite for better performance,
  # reliability, and concurrent connections.
  #
  # To use MySQL:
  # 1. Uncomment the 'db' service below
  # 2. Set the environment variables (use secrets in production!)
  # 3. Uncomment 'depends_on' in the backend service
  # 4. Update DB_CONNECTION in backend environment to 'mysql'
  # =============================================================================

  # -----------------------------------------------------------------------------
  # MySQL Database (Uncomment for production use)
  # -----------------------------------------------------------------------------
  # db:
  #   image: mysql:8.0
  #   container_name: secure-drop-db
  #   restart: always
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-change_me_in_production}
  #     MYSQL_DATABASE: ${MYSQL_DATABASE:-secure_drop}
  #     MYSQL_USER: ${MYSQL_USER:-secure_drop_user}
  #     MYSQL_PASSWORD: ${MYSQL_PASSWORD:-change_me_in_production}
  #   volumes:
  #     - mysql-data:/var/lib/mysql
  #   networks:
  #     - secure-drop-network
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-change_me_in_production}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1'
  #         memory: 1G
  #       reservations:
  #         cpus: '0.25'
  #         memory: 256M

  # Backend - Production configuration
  backend:
    build:
      context: ./backend
      target: production
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_KEY=${APP_KEY}
      - APP_URL=${APP_URL:-https://secure-drop.example.com}
      - FRONTEND_URL=${FRONTEND_URL:-https://secure-drop-ui.example.com}
      # ===========================================================================
      # DATABASE CONFIGURATION (PRODUCTION)
      # ===========================================================================
      # IMPORTANT: Change all passwords and use environment variables or secrets!

      # --- OPTION 1: SQLite (Not recommended for production) ---
      - DB_CONNECTION=${DB_CONNECTION:-sqlite}

      # --- OPTION 2: MySQL (Recommended for production - Uncomment below) ---
      # - DB_CONNECTION=mysql
      # - DB_HOST=db
      # - DB_PORT=3306
      # - DB_DATABASE=${MYSQL_DATABASE:-secure_drop}
      # - DB_USERNAME=${MYSQL_USER:-secure_drop_user}
      # - DB_PASSWORD=${MYSQL_PASSWORD:-change_me_in_production}
      # ===========================================================================
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
    restart: always
    # depends_on:
    #   db:
    #     condition: service_healthy  # Uncomment when using MySQL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # Frontend - Production configuration
  frontend:
    build:
      context: ./frontend
      target: production
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

volumes:
  letsencrypt:
  # mysql-data:  # Uncomment when using MySQL to persist database data
